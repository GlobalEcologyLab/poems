<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Population introduction via translocation functions • poems</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Population introduction via translocation functions">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">poems</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/simple_example.html">Simple workflow example for a population model</a></li>
    <li><a class="dropdown-item" href="../articles/thylacine_example.html">Workflow example for the Tasmanian thylacine</a></li>
    <li><a class="dropdown-item" href="../articles/translocation_example.html">Population introduction via translocation functions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/GlobalEcologyLab/poems/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Population introduction via translocation functions</h1>
                        <h4 data-toc-skip class="author">Global ChEC
Lab</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/GlobalEcologyLab/poems/blob/main/vignettes/translocation_example.Rmd" class="external-link"><code>vignettes/translocation_example.Rmd</code></a></small>
      <div class="d-none name"><code>translocation_example.Rmd</code></div>
    </div>

    
    
<p>In this vignette we present a simple example of the <em>poems</em>
workflow to show how to use a custom <code>translocation</code> function
to introduce populations at defined time steps. The vignette also shows
how to define different growth rates for populations in different
regions.</p>
<p>Note that the examples are for a single stage matrix model.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>As before, We begin by loading the necessary packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/GlobalEcologyLab/poems" class="external-link">poems</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringi.gagolewski.com/" class="external-link">stringi</a></span><span class="op">)</span> <span class="co"># for randomly generating file names.</span></span>
<span></span>
<span><span class="co"># function to round to any arbitrary value</span></span>
<span><span class="va">round_any</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">accuracy</span>, <span class="va">f</span> <span class="op">=</span> <span class="va">round</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">f</span><span class="op">(</span><span class="va">x</span> <span class="op">/</span> <span class="va">accuracy</span><span class="op">)</span> <span class="op">*</span> <span class="va">accuracy</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
<div class="section level2">
<h2 id="step-1-build-the-population-model-for-the-study-region">Step 1: Build the population model for the study region<a class="anchor" aria-label="anchor" href="#step-1-build-the-population-model-for-the-study-region"></a>
</h2>
<p>Create a model template using the <em>PopulationModel</em> class.
This model is spatially explicit, so is defined using the
<em>Region</em> class. In addition we make the model
<strong>temporally</strong> explicit so we can introduce populations at
defined time steps.</p>
<div class="section level3">
<h3 id="study-region">Study region<a class="anchor" aria-label="anchor" href="#study-region"></a>
</h3>
<p>First, we’ll define our study region. For this example, we utilise a
<code>raster::RasterLayer()</code> of Thylacine habitat suitability.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Region raster</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">tasmania_raster</span><span class="op">)</span></span>
<span><span class="va">tasmania_raster</span></span>
<span><span class="co">#&gt; class      : RasterLayer </span></span>
<span><span class="co">#&gt; dimensions : 32, 40, 1280  (nrow, ncol, ncell)</span></span>
<span><span class="co">#&gt; resolution : 0.1, 0.1  (x, y)</span></span>
<span><span class="co">#&gt; extent     : 144.5, 148.5, -43.8025, -40.6025  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs        : +proj=longlat +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +no_defs </span></span>
<span><span class="co">#&gt; source     : memory</span></span>
<span><span class="co">#&gt; names      : layer </span></span>
<span><span class="co">#&gt; values     : 1, 1  (min, max)</span></span>
<span></span>
<span><span class="co"># Equal area projection</span></span>
<span><span class="va">tasPrj</span> <span class="op">&lt;-</span> <span class="st">'PROJCS["Tasmania_Lambert_Azimuthal",</span></span>
<span><span class="st">                 GEOGCS["GCS_WGS_1984",</span></span>
<span><span class="st">                        DATUM["D_WGS_1984",</span></span>
<span><span class="st">                              SPHEROID["WGS_1984",6378137.0,298.257223563]],</span></span>
<span><span class="st">                        PRIMEM["Greenwich",0.0],</span></span>
<span><span class="st">                        UNIT["Degree",0.0174532925199433]],</span></span>
<span><span class="st">                 PROJECTION["Lambert_Azimuthal_Equal_Area"],</span></span>
<span><span class="st">                 PARAMETER["False_Easting",0.0],</span></span>
<span><span class="st">                 PARAMETER["False_Northing",0.0],</span></span>
<span><span class="st">                 PARAMETER["Central_Meridian",147],</span></span>
<span><span class="st">                 PARAMETER["Latitude_Of_Origin",-42.2],</span></span>
<span><span class="st">                 UNIT["Meter",1.0]]'</span></span>
<span></span>
<span><span class="co"># Template raster to project to</span></span>
<span><span class="va">tempExt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projectRaster.html" class="external-link">projectExtent</a></span><span class="op">(</span><span class="va">tasmania_raster</span>, <span class="va">tasPrj</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">res</a></span><span class="op">(</span><span class="va">tempExt</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">10000</span> <span class="co"># 10 km resolution</span></span>
<span><span class="va">tempExt</span></span>
<span><span class="co">#&gt; class      : RasterLayer </span></span>
<span><span class="co">#&gt; dimensions : 36, 34, 1224  (nrow, ncol, ncell)</span></span>
<span><span class="co">#&gt; resolution : 10000, 10000  (x, y)</span></span>
<span><span class="co">#&gt; extent     : -211571.8, 128428.2, -182583.2, 177416.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs        : +proj=laea +lat_0=-42.2 +lon_0=147 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs</span></span>
<span></span>
<span><span class="co"># Project the region</span></span>
<span><span class="va">tasmania_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projectRaster.html" class="external-link">projectRaster</a></span><span class="op">(</span><span class="va">tasmania_raster</span>, <span class="va">tempExt</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"ngb"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tasmania_raster</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Tasmania raster"</span>,</span>
<span>  legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"#2E8B57"</span>, colNA <span class="op">=</span> <span class="st">"grey75"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="unnamed-chunk-2-1.png" alt="plot of chunk unnamed-chunk-2"><p class="caption">
plot of chunk unnamed-chunk-2
</p>
</div>
<div style="page-break-after: always;"></div>
<p>Now we can define our <code><a href="../reference/Region.html">poems::Region</a></code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Tasmania study region (735 non-NA cells stored in the order shown) #</span></span>
<span><span class="va">region</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Region.html">Region</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>template_raster <span class="op">=</span> <span class="va">tasmania_raster</span><span class="op">)</span></span>
<span><span class="va">region</span><span class="op">$</span><span class="va">region_raster</span></span>
<span><span class="co">#&gt; class      : RasterLayer </span></span>
<span><span class="co">#&gt; dimensions : 36, 34, 1224  (nrow, ncol, ncell)</span></span>
<span><span class="co">#&gt; resolution : 10000, 10000  (x, y)</span></span>
<span><span class="co">#&gt; extent     : -211571.8, 128428.2, -182583.2, 177416.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs        : +proj=laea +lat_0=-42.2 +lon_0=147 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source     : memory</span></span>
<span><span class="co">#&gt; names      : layer </span></span>
<span><span class="co">#&gt; values     : 1, 735  (min, max)</span></span>
<span></span>
<span><span class="co"># Establish HS template and starting location #</span></span>
<span><span class="co"># This will be our initial introduction point</span></span>
<span><span class="va">int_ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf_project.html" class="external-link">sf_project</a></span><span class="op">(</span></span>
<span>  from <span class="op">=</span> <span class="st">"EPSG:4326"</span>,</span>
<span>  to <span class="op">=</span> <span class="va">tasPrj</span>,</span>
<span>  pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">146.44</span>, <span class="op">-</span><span class="fl">41.18</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">int_point</span> <span class="op">&lt;-</span> <span class="va">region</span><span class="op">$</span><span class="va">region_indices</span><span class="op">[</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">region_indices</span> <span class="op">==</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">cellFromXY</a></span><span class="op">(</span><span class="va">tasmania_raster</span>, xy <span class="op">=</span> <span class="va">int_ll</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co"># row which corresponds to initial introduction site</span></span>
<span><span class="va">int_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">region_indices</span> <span class="op">==</span> <span class="va">int_point</span><span class="op">)</span> <span class="co"># 114</span></span>
<span></span>
<span><span class="co"># plot of region, and introduction locations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">region_raster</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Tasmanian study region (cell indices)"</span>,</span>
<span>  colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">xyFromCell</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">region_raster</span>, <span class="va">int_point</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-3-1.png" alt="plot of chunk unnamed-chunk-3"><p class="caption">
plot of chunk unnamed-chunk-3
</p>
</div>
</div>
<div class="section level3">
<h3 id="land-use-modifier">Land-use modifier<a class="anchor" aria-label="anchor" href="#land-use-modifier"></a>
</h3>
<p>Here we read in a land-use modifier layer which we can use to make
our region spatiotemporally explicit. This has the effect of altering
the HS values through time which causes dynamic changes in habitat
suitability, and thus population abundances.</p>
<p>While we could change these values now and supply them as is to the
simulator. In this example, we will use a <em>Generator</em> object
later on to apply the HS scaling.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read in the land-use modifier</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">tasmania_modifier</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tasmania_modifier</span>,</span>
<span>  zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">100</span>, <span class="st">"RdYlGn"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-4-1.png" alt="plot of chunk unnamed-chunk-4"><p class="caption">
plot of chunk unnamed-chunk-4
</p>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Habitat suitability</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">thylacine_hs_raster</span><span class="op">)</span></span>
<span><span class="va">hs_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projectRaster.html" class="external-link">projectRaster</a></span><span class="op">(</span><span class="va">thylacine_hs_raster</span>, <span class="va">region</span><span class="op">$</span><span class="va">region_raster</span>, method <span class="op">=</span> <span class="st">"bilinear"</span><span class="op">)</span></span>
<span><span class="va">hs_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/stretch.html" class="external-link">stretch</a></span><span class="op">(</span><span class="va">hs_raster</span>, minv <span class="op">=</span> <span class="fl">0</span>, maxv <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">hs_raster</span></span>
<span><span class="co">#&gt; class      : RasterLayer </span></span>
<span><span class="co">#&gt; dimensions : 36, 34, 1224  (nrow, ncol, ncell)</span></span>
<span><span class="co">#&gt; resolution : 10000, 10000  (x, y)</span></span>
<span><span class="co">#&gt; extent     : -211571.8, 128428.2, -182583.2, 177416.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs        : +proj=laea +lat_0=-42.2 +lon_0=147 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source     : memory</span></span>
<span><span class="co">#&gt; names      : layer </span></span>
<span><span class="co">#&gt; values     : 0, 1  (min, max)</span></span>
<span></span>
<span><span class="co"># initial_hs needed for generator</span></span>
<span><span class="va">initial_hs</span> <span class="op">&lt;-</span> <span class="va">hs_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html" class="external-link">stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/nlayers.html" class="external-link">nlayers</a></span><span class="op">(</span><span class="va">tasmania_modifier</span><span class="op">)</span>, <span class="va">hs_raster</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
<p>While we have read in the land-use modifier, we have not applied it
to the HS values yet. This means that our HS values are still static as
shown by the plot below.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># static HS for the moment</span></span>
<span><span class="co">## capacity generator will make it temporally dynamic</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hs_raster</span>,</span>
<span>  zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">100</span>, <span class="st">"RdYlGn"</span><span class="op">)</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">xyFromCell</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">region_raster</span>, <span class="va">int_point</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-5-1.png" alt="plot of chunk unnamed-chunk-5"><p class="caption">
plot of chunk unnamed-chunk-5
</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="section level3">
<h3 id="environmental-correlation">Environmental correlation<a class="anchor" aria-label="anchor" href="#environmental-correlation"></a>
</h3>
<p>Next, we’ll define a distance-based spatial correlation for applying
environmental stochasticity within our model. The generated correlation
data is compacted for computational efficiency (with large-scale
models).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Distance-based environmental correlation (via a compacted Cholesky decomposition)</span></span>
<span><span class="va">env_corr</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SpatialCorrelation.html">SpatialCorrelation</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  region <span class="op">=</span> <span class="va">region</span>,</span>
<span>  amplitude <span class="op">=</span> <span class="fl">0.496</span>,</span>
<span>  breadth <span class="op">=</span> <span class="fl">80</span>,</span>
<span>  distance_scale <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span><span class="va">env_corr</span><span class="op">$</span><span class="fu">calculate_compact_decomposition</span><span class="op">(</span>decimals <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="spatially-varying-growth-rates">Spatially-varying growth rates<a class="anchor" aria-label="anchor" href="#spatially-varying-growth-rates"></a>
</h3>
<p>Here we use IBRA regions to define varying growth rates for different
populations. These could be expected to occur for example in a
wide-ranging species that occurs in varying habitats (e.g. red foxes in
Australia).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># allow growth rates to vary by region using IBRA regions</span></span>
<span><span class="co"># Tasmania study Interim Bioregionalisation of Australia (IBRA) bioregion cell distribution</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">tasmania_ibra_raster</span><span class="op">)</span></span>
<span><span class="va">ibra_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projectRaster.html" class="external-link">projectRaster</a></span><span class="op">(</span><span class="va">tasmania_ibra_raster</span>, <span class="va">region</span><span class="op">$</span><span class="va">region_raster</span>, method <span class="op">=</span> <span class="st">"ngb"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_raster</span>,</span>
<span>  colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">9</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"IBRA regions of Tasmania"</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">10</span>, <span class="st">"Lajolla"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-7-1.png" alt="plot of chunk unnamed-chunk-7"><p class="caption">
plot of chunk unnamed-chunk-7
</p>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">tasmania_ibra_data</span><span class="op">)</span></span>
<span><span class="va">tasmania_ibra_data</span></span>
<span><span class="co">#&gt;   index key abbr                        name</span></span>
<span><span class="co">#&gt; 1     1   A  FUR                    Furneaux</span></span>
<span><span class="co">#&gt; 2     2   B  BEN                  Ben Lomond</span></span>
<span><span class="co">#&gt; 3     3   C  TNM Tasmanian Northern Midlands</span></span>
<span><span class="co">#&gt; 4     4   D  TSE        Tasmanian South East</span></span>
<span><span class="co">#&gt; 5     5   E   TW              Tasmanian West</span></span>
<span><span class="co">#&gt; 6     6   F  TNS   Tasmanian Northern Slopes</span></span>
<span><span class="co">#&gt; 7     7   G  TSR   Tasmanian Southern Ranges</span></span>
<span><span class="co">#&gt; 8     8   H  TCH Tasmanian Central Highlands</span></span>
<span><span class="co">#&gt; 9     9   I  KIN                        King</span></span>
<span></span>
<span><span class="co"># Calculate cell indices and counts for IBRA bioregions</span></span>
<span><span class="va">ibra_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">tasmania_ibra_data</span><span class="op">$</span><span class="va">index</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">ibra_raster</span><span class="op">[</span><span class="va">region</span><span class="op">$</span><span class="va">region_indices</span><span class="op">]</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">ibra_indices</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 9</span></span>
<span><span class="co">#&gt;  $ : int [1:50] 11 12 20 21 22 23 24 25 35 36 ...</span></span>
<span><span class="co">#&gt;  $ : int [1:68] 40 42 65 66 67 68 92 93 94 95 ...</span></span>
<span><span class="co">#&gt;  $ : int [1:37] 180 181 209 210 211 212 213 238 239 240 ...</span></span>
<span><span class="co">#&gt;  $ : int [1:131] 307 308 330 331 332 333 334 335 336 337 ...</span></span>
<span><span class="co">#&gt;  $ : int [1:166] 104 131 132 133 134 135 162 163 164 165 ...</span></span>
<span><span class="co">#&gt;  $ : int [1:59] 56 57 78 79 80 81 82 83 84 105 ...</span></span>
<span><span class="co">#&gt;  $ : int [1:88] 404 429 430 431 432 457 458 459 483 484 ...</span></span>
<span><span class="co">#&gt;  $ : int [1:87] 199 200 201 202 229 230 231 232 258 259 ...</span></span>
<span><span class="co">#&gt;  $ : int [1:49] 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span></span>
<span><span class="va">ibra_polygons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterToPolygons.html" class="external-link">rasterToPolygons</a></span><span class="op">(</span><span class="va">ibra_raster</span>, dissolve <span class="op">=</span> <span class="cn">TRUE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ibra_polygons</span><span class="op">@</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">ibra_polygons</span><span class="op">@</span><span class="va">data</span>, <span class="va">tasmania_ibra_data</span>,</span>
<span>  by.x <span class="op">=</span> <span class="st">"layer"</span>, by.y <span class="op">=</span> <span class="st">"index"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ibra_polygons</span></span>
<span><span class="co">#&gt; class       : SpatialPolygonsDataFrame </span></span>
<span><span class="co">#&gt; features    : 9 </span></span>
<span><span class="co">#&gt; extent      : -201571.8, 118428.2, -162583.2, 177416.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs         : +proj=laea +lat_0=-42.2 +lon_0=147 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs </span></span>
<span><span class="co">#&gt; variables   : 4</span></span>
<span><span class="co">#&gt; names       : layer, key, abbr,           name </span></span>
<span><span class="co">#&gt; min values  :     1,   A,  BEN,     Ben Lomond </span></span>
<span><span class="co">#&gt; max values  :     9,   I,   TW, Tasmanian West</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">9</span>, <span class="st">"Lajolla"</span><span class="op">)</span>, border <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, labels <span class="op">=</span> <span class="st">"abbr"</span>, cex <span class="op">=</span> <span class="fl">1.2</span>, halo <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-7-2.png" alt="plot of chunk unnamed-chunk-7"><p class="caption">
plot of chunk unnamed-chunk-7
</p>
</div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">rmax_regional</span> <span class="op">&lt;-</span> <span class="va">ibra_raster</span></span>
<span></span>
<span><span class="co"># seed is set to keep example results constant</span></span>
<span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">27</span><span class="op">)</span></span>
<span>  <span class="va">rmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">0.94</span>, <span class="fl">0.3</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">val</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rmax_regional</span><span class="op">[</span><span class="va">rmax_regional</span> <span class="op">==</span> <span class="va">val</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rmax</span><span class="op">[</span><span class="va">val</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rmax_regional</span>,</span>
<span>  colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  legend <span class="op">=</span> <span class="cn">FALSE</span>, main <span class="op">=</span> <span class="st">"regional growth rates"</span>,</span>
<span>  zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">rmax</span><span class="op">)</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_polygons</span>,</span>
<span>      border <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">9</span>, <span class="st">"Lajolla"</span><span class="op">)</span>,</span>
<span>      col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, labels <span class="op">=</span> <span class="va">rmax</span>, halo <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">100</span>, <span class="st">"Zissou"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-7-3.png" alt="plot of chunk unnamed-chunk-7"><p class="caption">
plot of chunk unnamed-chunk-7
</p>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># set upper and lower growth rates per region</span></span>
<span><span class="va">ibra_rmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">tasmania_ibra_data</span>,</span>
<span>  rmax_lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rmax</span> <span class="op">*</span> <span class="fl">0.6</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  rmax_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rmax</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  rmax_upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rmax</span> <span class="op">/</span> <span class="fl">0.75</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ibra_rmax</span></span>
<span><span class="co">#&gt;   index key abbr                        name rmax_lower rmax_mean rmax_upper</span></span>
<span><span class="co">#&gt; 1     1   A  FUR                    Furneaux       2.70       4.5       6.00</span></span>
<span><span class="co">#&gt; 2     2   B  BEN                  Ben Lomond       2.16       3.6       4.80</span></span>
<span><span class="co">#&gt; 3     3   C  TNM Tasmanian Northern Midlands       1.20       2.0       2.67</span></span>
<span><span class="co">#&gt; 4     4   D  TSE        Tasmanian South East       1.02       1.7       2.27</span></span>
<span><span class="co">#&gt; 5     5   E   TW              Tasmanian West       1.08       1.8       2.40</span></span>
<span><span class="co">#&gt; 6     6   F  TNS   Tasmanian Northern Slopes       1.68       2.8       3.73</span></span>
<span><span class="co">#&gt; 7     7   G  TSR   Tasmanian Southern Ranges       1.56       2.6       3.47</span></span>
<span><span class="co">#&gt; 8     8   H  TCH Tasmanian Central Highlands       2.16       3.6       4.80</span></span>
<span><span class="co">#&gt; 9     9   I  KIN                        King       2.94       4.9       6.53</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="section level2">
<h2 id="step-2-setup-the-translocation-function">Step 2: Setup the translocation function<a class="anchor" aria-label="anchor" href="#step-2-setup-the-translocation-function"></a>
</h2>
<p>Here we generate a custom <em>Translocation</em> class object. This
object can be used to translocate populations from one location to
another, or as shown here, to introduce populations at defined locations
and timesteps. The function could also be expanded to introduce varying
number of animals at each site. For simplicity sake, this example
releases the same number of animals at all locations.</p>
<div class="section level3">
<h3 id="introduction-sites-and-times">Introduction sites and times<a class="anchor" aria-label="anchor" href="#introduction-sites-and-times"></a>
</h3>
<p>Here we define the introduction sites by matching
<code>region$region_indices</code> to our introduction locations.</p>
<p>We also define the timesteps that the introductions should occur.
These timesteps are sequential from 1, and are not defined by, for
example, calendar years.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up translocation locations and order</span></span>
<span><span class="va">intro_trans_ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf_project.html" class="external-link">sf_project</a></span><span class="op">(</span></span>
<span>  from <span class="op">=</span> <span class="st">"EPSG:4326"</span>,</span>
<span>  to <span class="op">=</span> <span class="va">tasPrj</span>,</span>
<span>  pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">148.01</span>, <span class="fl">144.7</span>, <span class="fl">147.9</span>, <span class="fl">148.27</span>, <span class="fl">145.24</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">40.8</span>, <span class="op">-</span><span class="fl">40.7</span>, <span class="op">-</span><span class="fl">43.2</span>, <span class="op">-</span><span class="fl">42.02</span>, <span class="op">-</span><span class="fl">42.3</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">intro_trans_ll</span></span>
<span><span class="co">#&gt;            [,1]       [,2]</span></span>
<span><span class="co">#&gt; [1,]   85234.38  154987.89</span></span>
<span><span class="co">#&gt; [2,] -194366.53  163999.33</span></span>
<span><span class="co">#&gt; [3,]   73150.82 -111470.77</span></span>
<span><span class="co">#&gt; [4,]  105182.23   19214.10</span></span>
<span><span class="co">#&gt; [5,] -145117.36  -12600.28</span></span>
<span><span class="va">intro_trans_point</span> <span class="op">&lt;-</span> <span class="va">region</span><span class="op">$</span><span class="va">region_indices</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">region_indices</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">cellFromXY</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">region_raster</span>,</span>
<span>    xy <span class="op">=</span> <span class="va">intro_trans_ll</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">intro_trans_point</span> <span class="op">&lt;-</span> <span class="va">intro_trans_point</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">intro_cells</span> <span class="op">&lt;-</span> <span class="va">intro_trans_point</span></span>
<span><span class="va">intro_cells</span></span>
<span><span class="co">#&gt; [1]  98 542 653 981</span></span>
<span></span>
<span><span class="va">intro_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Introduction times and locations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">intro_times</span>, <span class="va">intro_cells</span><span class="op">)</span></span>
<span><span class="co">#&gt;      intro_times intro_cells</span></span>
<span><span class="co">#&gt; [1,]           2          98</span></span>
<span><span class="co">#&gt; [2,]           3         542</span></span>
<span><span class="co">#&gt; [3,]           6         653</span></span>
<span><span class="co">#&gt; [4,]           8         981</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">region_raster</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Introduction sites"</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">100</span>, <span class="st">"Lajolla"</span><span class="op">)</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, border <span class="op">=</span> <span class="st">"black"</span>, col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">xyFromCell</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">region_raster</span>, <span class="va">intro_cells</span><span class="op">)</span>,</span>
<span>      pch <span class="op">=</span> <span class="fl">16</span>,</span>
<span>      cex <span class="op">=</span> <span class="fl">1.5</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"darkgreen"</span>, <span class="st">"blue2"</span>, <span class="st">"black"</span>, <span class="st">"goldenrod"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">coordinates</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">region</span><span class="op">$</span><span class="va">region_indices</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">intro_cells</span><span class="op">)</span>, <span class="op">]</span>,</span>
<span>      col <span class="op">=</span> <span class="st">"firebrick"</span>, cex <span class="op">=</span> <span class="fl">1.5</span>, lwd <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-8-1.png" alt="plot of chunk unnamed-chunk-8"><p class="caption">
plot of chunk unnamed-chunk-8
</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="section level3">
<h3 id="translocation-function">Translocation function<a class="anchor" aria-label="anchor" href="#translocation-function"></a>
</h3>
<p>Here we define the custom <code>translocation</code> function. It’s
simply a <code>list</code> object, with a nested function that uses
parameters from the model to make changes to the simulated
populations.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># User-defined translocation function (list-nested) and alias ####</span></span>
<span></span>
<span><span class="va">translocation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span></span>
<span>  <span class="co"># Function parameters (passed to function in params list)</span></span>
<span>  intro_cells <span class="op">=</span> <span class="va">intro_cells</span>, <span class="co"># cells where pops are introduced</span></span>
<span>  intro_timesteps <span class="op">=</span> <span class="va">intro_times</span>, <span class="co"># timesteps when introduced</span></span>
<span>  trans_n <span class="op">=</span> <span class="fl">50</span>, <span class="co"># translocated abundances. If not provided by LHS == 50</span></span>
<span>  region_indices <span class="op">=</span> <span class="va">region</span><span class="op">$</span><span class="va">region_indices</span>,</span>
<span></span>
<span>  <span class="co"># Function definition</span></span>
<span>  translocation_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Unpack parameters (used at every time step)</span></span>
<span>    <span class="va">intro_cells</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">intro_cells</span></span>
<span>    <span class="va">intro_timesteps</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">intro_timesteps</span></span>
<span>    <span class="va">simulator</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">simulator</span></span>
<span>    <span class="va">stages</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">stages</span></span>
<span>    <span class="va">populations</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">populations</span></span>
<span>    <span class="va">abundances</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">abundance</span></span>
<span>    <span class="va">region_indices</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">region_indices</span></span>
<span>    <span class="va">tm</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">tm</span> <span class="co"># timestep</span></span>
<span>    <span class="va">sa</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">stage_abundance</span></span>
<span>    <span class="va">trans_n</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">trans_n</span></span>
<span>    <span class="co"># if introduction at timestep, introduce pops</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">tm</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">intro_timesteps</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># take stage abundance at timestep</span></span>
<span>      <span class="va">new_sa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">sa</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stages</span>, <span class="va">populations</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="co"># identifies location of introduction</span></span>
<span>      <span class="va">trans_loc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">region_indices</span> <span class="op">==</span> <span class="va">intro_cells</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">intro_timesteps</span> <span class="op">==</span> <span class="va">tm</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="co"># add n individuals regardless of K</span></span>
<span>      <span class="va">new_sa</span><span class="op">[</span><span class="va">trans_loc</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">new_sa</span><span class="op">[</span><span class="va">trans_loc</span><span class="op">]</span> <span class="op">+</span> <span class="va">trans_n</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">new_sa</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># else return pops as they are</span></span>
<span>      <span class="va">new_sa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">sa</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stages</span>, <span class="va">populations</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">new_sa</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="va">translocation_aliases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  intro_cells <span class="op">=</span> <span class="st">"translocation$intro_cells"</span>,</span>
<span>  intro_times <span class="op">=</span> <span class="st">"translocation$intro_timesteps"</span>,</span>
<span>  trans_n <span class="op">=</span> <span class="st">"translocation$trans_n"</span>,</span>
<span>  region_indices <span class="op">=</span> <span class="st">"translocation$region_indices"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="section level2">
<h2 id="step-3-build-generators-for-dynamically-generating-model-parameters">Step 3: Build generators for dynamically generating model
parameters<a class="anchor" aria-label="anchor" href="#step-3-build-generators-for-dynamically-generating-model-parameters"></a>
</h2>
<div class="section level3">
<h3 id="growth-rate-generator">Growth rate generator<a class="anchor" aria-label="anchor" href="#growth-rate-generator"></a>
</h3>
<p>Now we can build a <em>Generator</em> class object that will generate
random growth rates based on quantiles between the min and max in each
IBRA region. This allows us to sample across the range of values within
each region.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build a Rmax generator based on sampled IBRA Rmax range quantile</span></span>
<span><span class="va">rmax_gen</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Generator.html">Generator</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  description <span class="op">=</span> <span class="st">"Rmax"</span>,</span>
<span>  spatial_correlation <span class="op">=</span> <span class="va">env_corr</span>,</span>
<span>  generate_rasters <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  ibra_data_rmax <span class="op">=</span> <span class="va">ibra_rmax</span>,</span>
<span>  ibra_indices <span class="op">=</span> <span class="va">ibra_indices</span>,</span>
<span>  region_cells <span class="op">=</span> <span class="va">region</span><span class="op">$</span><span class="va">region_cells</span>,</span>
<span>  inputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rmax_quantile"</span><span class="op">)</span>,</span>
<span>  outputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"growth_rate_max"</span><span class="op">)</span>,</span>
<span>  generative_requirements <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>growth_rate_max <span class="op">=</span> <span class="st">"function"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># growth_rate_max template</span></span>
<span><span class="va">rmax_gen</span><span class="op">$</span><span class="fu">add_function_template</span><span class="op">(</span></span>
<span>  <span class="st">"growth_rate_max"</span>,</span>
<span>  function_def <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">growth_rate_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">params</span><span class="op">$</span><span class="va">region_cells</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">ibra_data_rmax</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">growth_rate_max</span><span class="op">[</span><span class="va">params</span><span class="op">$</span><span class="va">ibra_indices</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>        <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">qunif</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">rmax_quantile</span>,</span>
<span>          min <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">ibra_data_rmax</span><span class="op">$</span><span class="va">rmax_lower</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>          max <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">ibra_data_rmax</span><span class="op">$</span><span class="va">rmax_upper</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">growth_rate_max</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  call_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ibra_data_rmax"</span>, <span class="st">"ibra_indices"</span>, <span class="st">"region_cells"</span>, <span class="st">"rmax_quantile"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># test rmax generator at median values</span></span>
<span><span class="va">rmax_gen_ex</span> <span class="op">&lt;-</span> <span class="va">rmax_gen</span><span class="op">$</span><span class="fu">generate</span><span class="op">(</span>input_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rmax_quantile <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rmax_regional</span><span class="op">[</span><span class="va">region</span><span class="op">$</span><span class="va">region_indices</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rmax_gen_ex</span><span class="op">$</span><span class="va">growth_rate_max</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rmax_regional</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"median regional rmax"</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, border <span class="op">=</span> <span class="st">"black"</span>, col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-10-1.png" alt="plot of chunk unnamed-chunk-10"><p class="caption">
plot of chunk unnamed-chunk-10
</p>
</div>
<p>The map above shows the result of sampling our possible <em>rmax</em>
values to their median values. The plot below shows that we can sample
across a range of values using the same generator. This functionality
allows us to pass <code>rmax_quantile</code> as a variable in a
<em>LatinHypercubeSampler</em> class.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Test multiple quantiles</span></span>
<span><span class="va">test_rmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">region</span><span class="op">$</span><span class="fu">raster_from_values</span><span class="op">(</span><span class="va">rmax_gen</span><span class="op">$</span><span class="fu">generate</span><span class="op">(</span>input_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rmax_quantile <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">growth_rate_max</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">test_rmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html" class="external-link">stack</a></span><span class="op">(</span><span class="va">test_rmax</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">test_rmax</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Q"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">test_rmax</span>,</span>
<span>  colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  legend <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">test_rmax</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">test_rmax</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, border <span class="op">=</span> <span class="st">"black"</span>, col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-11-1.png" alt="plot of chunk unnamed-chunk-11"><p class="caption">
plot of chunk unnamed-chunk-11
</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="section level3">
<h3 id="dispersal-generator">Dispersal generator<a class="anchor" aria-label="anchor" href="#dispersal-generator"></a>
</h3>
<p>This generator controls dispersal across our region based on mean
dispersal distance and proportion of dispersers.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Dispersal generator ####</span></span>
<span><span class="co"># Set for veriable mean distance, max hard-coded at 150</span></span>
<span><span class="va">dispersal_gen</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/DispersalGenerator.html">DispersalGenerator</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  region <span class="op">=</span> <span class="va">region</span>,</span>
<span>  spatial_correlation <span class="op">=</span> <span class="va">env_corr</span>,</span>
<span>  generate_rasters <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  dispersal_max_distance <span class="op">=</span> <span class="fl">150</span>,</span>
<span>  distance_classes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">150</span>, by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  distance_scale <span class="op">=</span> <span class="fl">1000</span>, <span class="co"># in km</span></span>
<span>  dispersal_friction <span class="op">=</span> <span class="va"><a href="../reference/DispersalFriction.html">DispersalFriction</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>, <span class="co"># modify coastline distances</span></span>
<span>  inputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dispersal_p"</span>, <span class="st">"dispersal_b"</span><span class="op">)</span>, <span class="co"># proportion and average distance</span></span>
<span>  decimals <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span>
<span><span class="va">dispersal_gen</span><span class="op">$</span><span class="fu">calculate_distance_data</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dispersal_gen</span><span class="op">$</span><span class="va">distance_data</span><span class="op">$</span><span class="va">base</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;     target_pop source_pop compact_row distance_class</span></span>
<span><span class="co">#&gt; X2           2          1           1              2</span></span>
<span><span class="co">#&gt; X3           3          1           2              3</span></span>
<span><span class="co">#&gt; X4           4          1           3              2</span></span>
<span><span class="co">#&gt; X5           5          1           4              2</span></span>
<span><span class="co">#&gt; X6           6          1           5              2</span></span>
<span><span class="co">#&gt; X7           7          1           6              3</span></span>
<span><span class="co">#&gt; X8           8          1           7              4</span></span>
<span><span class="co">#&gt; X9           9          1           8              5</span></span>
<span><span class="co">#&gt; X10         10          1           9              6</span></span>
<span><span class="co">#&gt; X13         13          1          10              3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">dispersal_gen</span><span class="op">$</span><span class="va">distance_data</span><span class="op">$</span><span class="va">base</span><span class="op">$</span><span class="va">distance_class</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     2     3     4     5     6     7     8     9    10    11    12    13    14 </span></span>
<span><span class="co">#&gt;  5476  7790  9914 18696 15444 20798 19606 22140 29202 22426 26850 23702 28286 </span></span>
<span><span class="co">#&gt;    15 </span></span>
<span><span class="co">#&gt; 26086</span></span></code></pre></div>
<p>Like with the <code>rmax_gen</code> defined above, we can test our
dispersal generator over a range of values to make sure the dispersal
curve looks appropriate. We can see in the plot below that as the
proportion of dispersal decreases, so does the maximum dispersal
distance.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot dispersal curves for mean dispersal rates</span></span>
<span><span class="va">disp_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span>, <span class="va">b</span>, <span class="va">distance</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">distance</span> <span class="op">/</span> <span class="va">b</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">disp_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">5</span>, <span class="fl">40</span><span class="op">)</span> <span class="op">/</span> <span class="fl">100</span>, <span class="fl">2</span><span class="op">)</span>, <span class="co"># prop</span></span>
<span>  b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">5</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span> <span class="co"># mean distance</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">disp_mat</span><span class="op">)</span></span>
<span><span class="co">#&gt;      p  b</span></span>
<span><span class="co">#&gt; 1 0.26 22</span></span>
<span><span class="co">#&gt; 2 0.07 28</span></span>
<span><span class="co">#&gt; 3 0.08 25</span></span>
<span><span class="co">#&gt; 4 0.38 23</span></span>
<span><span class="co">#&gt; 5 0.23 23</span></span>
<span><span class="co">#&gt; 6 0.19 35</span></span>
<span></span>
<span><span class="va">disp_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">disp_mat</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">disp_mat</span><span class="op">[</span><span class="va">i</span>, <span class="st">"p"</span><span class="op">]</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="va">disp_mat</span><span class="op">[</span><span class="va">i</span>, <span class="st">"b"</span><span class="op">]</span></span>
<span>  <span class="va">disp_x</span> <span class="op">&lt;-</span> <span class="fu">disp_fun</span><span class="op">(</span><span class="va">p</span>, <span class="va">b</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">150</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">disp_x</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">150</span>, <span class="fl">5</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">30</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.4</span><span class="op">)</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"Disp. dist (km)"</span>, ylab <span class="op">=</span> <span class="st">"Prop. disp."</span>, yaxt <span class="op">=</span> <span class="st">"n"</span>, xaxt <span class="op">=</span> <span class="st">"n"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">150</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">40</span>, <span class="fl">5</span><span class="op">)</span> <span class="op">/</span> <span class="fl">100</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">40</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">disp_test</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">150</span>, <span class="fl">5</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, add <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#C9C9C944"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">150</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">disp_test</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"firebrick"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-13-1.png" alt="plot of chunk unnamed-chunk-13"><p class="caption">
plot of chunk unnamed-chunk-13
</p>
</div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span></code></pre></div>
<p>Now that we’re happy the curve follows the right form, we can
generate some dispersal data to test our population model with.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate sampled dispersals for p = 0.35, b = 40 (km)</span></span>
<span><span class="va">sample_dispersal_data</span> <span class="op">&lt;-</span> <span class="va">dispersal_gen</span><span class="op">$</span><span class="fu">generate</span><span class="op">(</span></span>
<span>  input_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>dispersal_p <span class="op">=</span> <span class="fl">0.35</span>, dispersal_b <span class="op">=</span> <span class="fl">40</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">dispersal_data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sample_dispersal_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span> <span class="co"># examine</span></span>
<span><span class="co">#&gt;     target_pop source_pop emigrant_row immigrant_row dispersal_rate</span></span>
<span><span class="co">#&gt; X2           2          1            1             1         0.0120</span></span>
<span><span class="co">#&gt; X3           3          1            2             1         0.0094</span></span>
<span><span class="co">#&gt; X4           4          1            3             1         0.0120</span></span>
<span><span class="co">#&gt; X5           5          1            4             1         0.0120</span></span>
<span><span class="co">#&gt; X6           6          1            5             1         0.0120</span></span>
<span><span class="co">#&gt; X7           7          1            6             1         0.0094</span></span>
<span><span class="co">#&gt; X8           8          1            7             1         0.0073</span></span>
<span><span class="co">#&gt; X9           9          1            8             1         0.0057</span></span>
<span><span class="co">#&gt; X10         10          1            9             1         0.0044</span></span>
<span><span class="co">#&gt; X13         13          1           10             1         0.0094</span></span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
<div class="section level3">
<h3 id="capacity-generator">Capacity generator<a class="anchor" aria-label="anchor" href="#capacity-generator"></a>
</h3>
<p>Here we build a carrying capacity generator. Carrying capacity is
based on maximum density values and scaled by HS (i.e. cells with a HS
of 1 contain the highest densities).</p>
<p>The capacity generator is set-up in such a way that it requires
multiple parameters to work.</p>
<p>1.<code>max_dens</code>: the maximum theoretical density of
populations</p>
<p>2.<code>q_thresh</code>: the quantile threshold used to rescale the
HS values</p>
<p>3.<code>trans_n</code>: the number of animals that are introduced.
This value is consistent with the <code>translocation</code>
function.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">capacity_gen</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Generator.html">Generator</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  description <span class="op">=</span> <span class="st">"capacity"</span>,</span>
<span>  spatial_correlation <span class="op">=</span> <span class="va">env_corr</span>,</span>
<span>  generate_rasters <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  time_steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">initial_hs</span><span class="op">)</span>,</span>
<span>  hs_raster <span class="op">=</span> <span class="va">initial_hs</span><span class="op">[</span><span class="va">region</span><span class="op">$</span><span class="va">region_indices</span><span class="op">]</span>, <span class="co"># provide full stack of HS. Template attached</span></span>
<span>  hs_mod <span class="op">=</span> <span class="va">tasmania_modifier</span><span class="op">[</span><span class="va">region</span><span class="op">$</span><span class="va">region_indices</span><span class="op">]</span>, <span class="co"># provide full stack of LULC modifier. Template attached</span></span>
<span>  int_index <span class="op">=</span> <span class="va">int_point</span>,</span>
<span>  trans_n <span class="op">=</span> <span class="va">translocation</span><span class="op">$</span><span class="va">trans_n</span>, <span class="co"># number of animals introduced</span></span>
<span>  region_indices <span class="op">=</span> <span class="va">region</span><span class="op">$</span><span class="va">region_indices</span>,</span>
<span>  inputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"max_dens"</span>, <span class="st">"q_thresh"</span>, <span class="st">"trans_n"</span><span class="op">)</span>,</span>
<span>  outputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"initial_abundance"</span>, <span class="st">"carrying_capacity"</span><span class="op">)</span>,</span>
<span>  generative_requirements <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initial_abundance <span class="op">=</span> <span class="st">"function"</span>,</span>
<span>    carrying_capacity <span class="op">=</span> <span class="st">"function"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">capacity_gen</span><span class="op">$</span><span class="fu">add_function_template</span><span class="op">(</span></span>
<span>  param <span class="op">=</span> <span class="st">"initial_abundance"</span>,</span>
<span>  function_def <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">distr_a</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">hs_raster</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="co">## 0 everywhere except the intro point at the first time step</span></span>
<span>    <span class="co">## intro point to trans_n</span></span>
<span>    <span class="co">## Could be above or below carrying capacity</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">region_indices</span> <span class="op">==</span> <span class="va">params</span><span class="op">$</span><span class="va">int_index</span><span class="op">)</span></span>
<span>    <span class="va">distr_a</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">trans_n</span></span>
<span>    <span class="va">distr_a</span><span class="op">[</span><span class="op">-</span><span class="va">idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">distr_a</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  call_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hs_raster"</span>, <span class="st">"int_index"</span>, <span class="st">"region_indices"</span>, <span class="st">"trans_n"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">capacity_gen</span><span class="op">$</span><span class="fu">add_function_template</span><span class="op">(</span></span>
<span>  <span class="st">"carrying_capacity"</span>,</span>
<span>  function_def <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">region_indices</span> <span class="op">==</span> <span class="va">params</span><span class="op">$</span><span class="va">int_index</span><span class="op">)</span></span>
<span>    <span class="va">distr_k</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">hs_raster</span></span>
<span>    <span class="va">distr_mod</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">hs_mod</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span></span>
<span>      <span class="st">"hs_raster and hs_mod have different number of layers"</span> <span class="op">=</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">distr_k</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">distr_mod</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="co"># stretch HS values based on q_thresh</span></span>
<span>    <span class="va">distr_k</span> <span class="op">&lt;-</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale.html" class="external-link">rescale</a></span><span class="op">(</span><span class="va">distr_k</span>, from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">params</span><span class="op">$</span><span class="va">q_thresh</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">distr_k</span><span class="op">[</span><span class="va">distr_k</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="va">distr_k</span><span class="op">[</span><span class="va">distr_k</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="co"># multiply thresholded HS by hs_modifier</span></span>
<span>    <span class="va">distr_k</span> <span class="op">&lt;-</span> <span class="va">distr_k</span> <span class="op">*</span> <span class="va">distr_mod</span></span>
<span>    <span class="co"># rescale back to {0, 1}</span></span>
<span>    <span class="va">qMax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">distr_k</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">distr_k</span> <span class="op">&lt;-</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale.html" class="external-link">rescale</a></span><span class="op">(</span><span class="va">distr_k</span>, from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">qMax</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">distr_k</span><span class="op">[</span><span class="va">distr_k</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="va">distr_k</span><span class="op">[</span><span class="va">distr_k</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="co"># carrying capacity = (HS * maximum density)</span></span>
<span>    <span class="va">distr_k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">distr_k</span> <span class="op">*</span> <span class="va">params</span><span class="op">$</span><span class="va">max_dens</span><span class="op">)</span></span>
<span>    <span class="va">distr_k</span><span class="op">[</span><span class="va">idx</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">max_dens</span></span>
<span>    <span class="co"># distr_k[-idx, 1] &lt;- 0</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">distr_k</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  call_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hs_raster"</span>, <span class="st">"hs_mod"</span>, <span class="st">"int_index"</span>, <span class="st">"region_indices"</span>, <span class="st">"max_dens"</span>, <span class="st">"q_thresh"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># have all parameters been specified correctly</span></span>
<span><span class="va">capacity_gen</span><span class="op">$</span><span class="fu">generative_requirements_satisfied</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $initial_abundance</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $carrying_capacity</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Now we have defined our generator we can make some test data for the
model</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate example initial abundance and declining carrying capacity time-series</span></span>
<span><span class="va">generated_k</span> <span class="op">&lt;-</span> <span class="va">capacity_gen</span><span class="op">$</span><span class="fu">generate</span><span class="op">(</span>input_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  max_dens <span class="op">=</span> <span class="fl">100</span>, q_thresh <span class="op">=</span> <span class="fl">0.90</span>,</span>
<span>  trans_n <span class="op">=</span> <span class="fl">60</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">example_initial_abundance</span> <span class="op">&lt;-</span> <span class="va">generated_k</span><span class="op">$</span><span class="va">initial_abundance</span></span>
<span><span class="va">example_carrying_capacity</span> <span class="op">&lt;-</span> <span class="va">generated_k</span><span class="op">$</span><span class="va">carrying_capacity</span></span>
<span></span>
<span><span class="co"># Plot the example initial abundance</span></span>
<span><span class="va">example_initial_n_raster</span> <span class="op">&lt;-</span> <span class="va">region</span><span class="op">$</span><span class="fu">raster_from_values</span><span class="op">(</span><span class="va">example_initial_abundance</span><span class="op">)</span></span>
<span><span class="va">example_initial_n_raster</span></span>
<span><span class="co">#&gt; class      : RasterLayer </span></span>
<span><span class="co">#&gt; dimensions : 36, 34, 1224  (nrow, ncol, ncell)</span></span>
<span><span class="co">#&gt; resolution : 10000, 10000  (x, y)</span></span>
<span><span class="co">#&gt; extent     : -211571.8, 128428.2, -182583.2, 177416.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs        : +proj=laea +lat_0=-42.2 +lon_0=147 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source     : memory</span></span>
<span><span class="co">#&gt; names      : layer </span></span>
<span><span class="co">#&gt; values     : 0, 60  (min, max)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">example_initial_n_raster</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Example initial abundance"</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">100</span>, <span class="st">"Lajolla"</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, border <span class="op">=</span> <span class="st">"black"</span>, col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-16-1.png" alt="plot of chunk unnamed-chunk-16"><p class="caption">
plot of chunk unnamed-chunk-16
</p>
</div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Plot the carrying capacity</span></span>
<span><span class="co">## carrying capacity is forced to maximum theoretical value at first time step</span></span>
<span><span class="va">example_k</span> <span class="op">&lt;-</span> <span class="va">region</span><span class="op">$</span><span class="fu">raster_from_values</span><span class="op">(</span><span class="va">example_carrying_capacity</span><span class="op">)</span></span>
<span><span class="va">example_k</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">11</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; class      : RasterBrick </span></span>
<span><span class="co">#&gt; dimensions : 36, 34, 1224, 3  (nrow, ncol, ncell, nlayers)</span></span>
<span><span class="co">#&gt; resolution : 10000, 10000  (x, y)</span></span>
<span><span class="co">#&gt; extent     : -211571.8, 128428.2, -182583.2, 177416.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs        : +proj=laea +lat_0=-42.2 +lon_0=147 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source     : memory</span></span>
<span><span class="co">#&gt; names      : layer.1, layer.6, layer.11 </span></span>
<span><span class="co">#&gt; min values :       0,       0,        0 </span></span>
<span><span class="co">#&gt; max values :     100,      67,       99</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">example_k</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">100</span>, <span class="st">"RdYlGn"</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, border <span class="op">=</span> <span class="st">"black"</span>, col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-16-2.png" alt="plot of chunk unnamed-chunk-16"><p class="caption">
plot of chunk unnamed-chunk-16
</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="section level2">
<h2 id="step-4-build-a-template-model">Step 4: Build a template model<a class="anchor" aria-label="anchor" href="#step-4-build-a-template-model"></a>
</h2>
<p>Using the generators we’ve built we can now test if our simple
population model works as expected.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Template model ####</span></span>
<span><span class="va">model_template</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PopulationModel.html">PopulationModel</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  region <span class="op">=</span> <span class="va">region</span>,</span>
<span>  time_steps <span class="op">=</span> <span class="fl">11</span>,</span>
<span>  years_per_step <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  stage_matrix <span class="op">=</span> <span class="fl">1</span>, <span class="co"># single-stage</span></span>
<span>  populations <span class="op">=</span> <span class="va">region</span><span class="op">$</span><span class="va">region_cells</span>, <span class="co"># 735</span></span>
<span>  demographic_stochasticity <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  standard_deviation <span class="op">=</span> <span class="fl">0.18</span>,</span>
<span>  density_dependence <span class="op">=</span> <span class="st">"logistic"</span>, <span class="co"># Ricker</span></span>
<span>  harvest <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># No harvest</span></span>
<span>  dispersal <span class="op">=</span> <span class="va">dispersal_gen</span>,</span>
<span>  translocation <span class="op">=</span> <span class="va">translocation</span>,</span>
<span>  dispersal_source_n_k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>threshold <span class="op">=</span> <span class="fl">0.92</span>, cutoff <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>  simulation_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"translocation"</span>, <span class="st">"results"</span>, <span class="st">"transition"</span>, <span class="st">"dispersal"</span><span class="op">)</span>,</span>
<span>  random_seed <span class="op">=</span> <span class="fl">20230210</span>,</span>
<span>  attribute_aliases <span class="op">=</span> <span class="va">translocation_aliases</span>,</span>
<span>  results_selection <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"abundance"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">model_template</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">set_attributes</span><span class="op">(</span></span>
<span>  initial_abundance <span class="op">=</span> <span class="va">example_initial_abundance</span>,</span>
<span>  carrying_capacity <span class="op">=</span> <span class="va">example_carrying_capacity</span>,</span>
<span>  growth_rate_max <span class="op">=</span> <span class="va">rmax_gen_ex</span><span class="op">$</span><span class="va">growth_rate_max</span>,</span>
<span>  translocation <span class="op">=</span> <span class="va">translocation</span>,</span>
<span>  trans_n <span class="op">=</span> <span class="fl">75</span>, <span class="co"># passed through to translocation function</span></span>
<span>  dispersal <span class="op">=</span> <span class="va">sample_dispersal_data</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># run poems simulator</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population_simulator.html">population_simulator</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="va">results</span><span class="op">$</span><span class="va">all</span><span class="op">$</span><span class="va">abundance</span></span>
<span><span class="co">#&gt;  [1]    60   461  1687  4826  6058  9342 10085 17090 13115 18711 12527</span></span>
<span></span>
<span><span class="co"># timeseries of total abundance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">11</span>, <span class="va">results</span><span class="op">$</span><span class="va">all</span><span class="op">$</span><span class="va">abundance</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"timestep"</span>, ylab <span class="op">=</span> <span class="st">"Total abundance"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-17-1.png" alt="plot of chunk unnamed-chunk-17"><p class="caption">
plot of chunk unnamed-chunk-17
</p>
</div>
<p>The template model runs successfully and now we can make some maps of
the dispersal patterns of the populations from their initial
introduction.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abund_ras</span> <span class="op">&lt;-</span> <span class="va">region</span><span class="op">$</span><span class="fu">raster_from_values</span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">abundance</span><span class="op">)</span></span>
<span><span class="va">abund_ras</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">11</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; class      : RasterBrick </span></span>
<span><span class="co">#&gt; dimensions : 36, 34, 1224, 3  (nrow, ncol, ncell, nlayers)</span></span>
<span><span class="co">#&gt; resolution : 10000, 10000  (x, y)</span></span>
<span><span class="co">#&gt; extent     : -211571.8, 128428.2, -182583.2, 177416.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs        : +proj=laea +lat_0=-42.2 +lon_0=147 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source     : memory</span></span>
<span><span class="co">#&gt; names      : layer.1, layer.6, layer.11 </span></span>
<span><span class="co">#&gt; min values :       0,       0,        0 </span></span>
<span><span class="co">#&gt; max values :      60,     250,      345</span></span>
<span><span class="va">abd_max</span> <span class="op">&lt;-</span> <span class="fu">round_any</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">abund_ras</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">20</span>, f <span class="op">=</span> <span class="va">ceiling</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot of abundances. log(x+1) transformed.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">abund_ras</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>  colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, border <span class="op">=</span> <span class="st">"black"</span>, col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">abd_max</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-18-1.png" alt="plot of chunk unnamed-chunk-18"><p class="caption">
plot of chunk unnamed-chunk-18
</p>
</div>
<p>To make sure our <code>translocation</code> function is working
correctly, we can run the template model again but with the
<code>translocation</code> function turned off.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">set_attributes</span><span class="op">(</span></span>
<span>  initial_abundance <span class="op">=</span> <span class="va">example_initial_abundance</span>,</span>
<span>  carrying_capacity <span class="op">=</span> <span class="va">example_carrying_capacity</span>,</span>
<span>  growth_rate_max <span class="op">=</span> <span class="va">rmax_gen_ex</span><span class="op">$</span><span class="va">growth_rate_max</span>,</span>
<span>  translocation <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  dispersal <span class="op">=</span> <span class="va">sample_dispersal_data</span></span>
<span><span class="op">)</span></span>
<span><span class="va">results_notransn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population_simulator.html">population_simulator</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="co"># run poems simulator</span></span>
<span><span class="va">results_notransn</span><span class="op">$</span><span class="va">all</span><span class="op">$</span><span class="va">abundance</span></span>
<span><span class="co">#&gt;  [1]    60   386  1614  4651  5532  8984  9672 15588 13801 17901 13641</span></span>
<span><span class="va">results</span><span class="op">$</span><span class="va">all</span><span class="op">$</span><span class="va">abundance</span></span>
<span><span class="co">#&gt;  [1]    60   461  1687  4826  6058  9342 10085 17090 13115 18711 12527</span></span>
<span><span class="va">abund_ras_notransn</span> <span class="op">&lt;-</span> <span class="va">region</span><span class="op">$</span><span class="fu">raster_from_values</span><span class="op">(</span><span class="va">results_notransn</span><span class="op">$</span><span class="va">abundance</span><span class="op">)</span></span>
<span><span class="va">abund_ras_notransn</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">11</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; class      : RasterBrick </span></span>
<span><span class="co">#&gt; dimensions : 36, 34, 1224, 3  (nrow, ncol, ncell, nlayers)</span></span>
<span><span class="co">#&gt; resolution : 10000, 10000  (x, y)</span></span>
<span><span class="co">#&gt; extent     : -211571.8, 128428.2, -182583.2, 177416.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs        : +proj=laea +lat_0=-42.2 +lon_0=147 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source     : memory</span></span>
<span><span class="co">#&gt; names      : layer.1, layer.6, layer.11 </span></span>
<span><span class="co">#&gt; min values :       0,       0,        0 </span></span>
<span><span class="co">#&gt; max values :      60,     278,      298</span></span>
<span><span class="va">diff_ras</span> <span class="op">&lt;-</span> <span class="va">abund_ras</span> <span class="op">-</span> <span class="va">abund_ras_notransn</span></span>
<span><span class="va">diff_ras</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; class      : RasterBrick </span></span>
<span><span class="co">#&gt; dimensions : 36, 34, 1224, 2  (nrow, ncol, ncell, nlayers)</span></span>
<span><span class="co">#&gt; resolution : 10000, 10000  (x, y)</span></span>
<span><span class="co">#&gt; extent     : -211571.8, 128428.2, -182583.2, 177416.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs        : +proj=laea +lat_0=-42.2 +lon_0=147 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source     : memory</span></span>
<span><span class="co">#&gt; names      : layer.1, layer.2 </span></span>
<span><span class="co">#&gt; min values :       0,       0 </span></span>
<span><span class="co">#&gt; max values :       0,      75</span></span></code></pre></div>
<p>We can see from the <code>diff_ras</code> above that the difference
between timesteps 2 of the two model runs is 75 individuals, which was
the value passed through to the <code>translocation</code> function of
the original model run.</p>
<p>And now we can plot the difference.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plotmax</span> <span class="op">&lt;-</span> <span class="fu">round_any</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">diff_ras</span><span class="op">)</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span>, <span class="va">ceiling</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">diff_ras</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">11</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">plotmax</span>, <span class="va">plotmax</span><span class="op">)</span>,</span>
<span>  breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">plotmax</span>, <span class="op">-</span><span class="fl">100</span>, <span class="op">-</span><span class="fl">50</span>, <span class="op">-</span><span class="fl">20</span>, <span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="va">plotmax</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">9</span>, <span class="st">"PuOr"</span><span class="op">)</span>,</span>
<span>  colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-20-1.png" alt="plot of chunk unnamed-chunk-20"><p class="caption">
plot of chunk unnamed-chunk-20
</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="section level2">
<h2 id="step-5-run-multiple-simulations">Step 5: Run multiple simulations<a class="anchor" aria-label="anchor" href="#step-5-run-multiple-simulations"></a>
</h2>
<p>In order to explore the model parameter space to find the best
models, we generate Latin hypercube samples of model and generator
parameters to be simulated, using the <em>LatinHypercubeSampler</em>
class. This class has functionality for generating sample parameters via
Uniform, Normal, Lognormal, Beta, and Triangular distributions. For our
example we only generate 10 samples. Typically however, a user would
need to generate thousands to tens of thousands, of samples.</p>
<div class="section level3">
<h3 id="define-the-latin-hypercube-for-sampling">Define the latin-hypercube for sampling<a class="anchor" aria-label="anchor" href="#define-the-latin-hypercube-for-sampling"></a>
</h3>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Latin-hypercube sampler ####</span></span>
<span><span class="va">lhs_gen</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/LatinHypercubeSampler.html">LatinHypercubeSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Habitat suitability threshold</span></span>
<span><span class="va">lhs_gen</span><span class="op">$</span><span class="fu">set_uniform_parameter</span><span class="op">(</span><span class="st">"q_thresh"</span>, lower <span class="op">=</span> <span class="fl">0.90</span>, upper <span class="op">=</span> <span class="fl">0.99</span>, decimals <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Growth rate</span></span>
<span><span class="va">lhs_gen</span><span class="op">$</span><span class="fu">set_uniform_parameter</span><span class="op">(</span><span class="st">"rmax_quantile"</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="fl">1</span>, decimals <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">lhs_gen</span><span class="op">$</span><span class="fu">set_uniform_parameter</span><span class="op">(</span><span class="st">"standard_deviation"</span>, lower <span class="op">=</span> <span class="fl">0.00</span>, upper <span class="op">=</span> <span class="fl">0.70</span>, decimals <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Dispersal</span></span>
<span><span class="va">lhs_gen</span><span class="op">$</span><span class="fu">set_uniform_parameter</span><span class="op">(</span><span class="st">"dispersal_p"</span>, lower <span class="op">=</span> <span class="fl">0.05</span>, upper <span class="op">=</span> <span class="fl">0.40</span>, decimals <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">## mean dispersal between 5 and 40 km</span></span>
<span><span class="va">lhs_gen</span><span class="op">$</span><span class="fu">set_uniform_parameter</span><span class="op">(</span><span class="st">"dispersal_b"</span>, lower <span class="op">=</span> <span class="fl">5</span>, upper <span class="op">=</span> <span class="fl">40</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">lhs_gen</span><span class="op">$</span><span class="fu">set_uniform_parameter</span><span class="op">(</span><span class="st">"dispersal_n_k_threshold"</span>, lower <span class="op">=</span> <span class="fl">0.7</span>, upper <span class="op">=</span> <span class="fl">1.0</span>, decimals <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Density max</span></span>
<span><span class="co">## Density: animals/km2 needs to be scaled by grid size (10km x 10km)</span></span>
<span><span class="co">## e.g. 1/km2 = (1 animal/km2 * (10*10) ) * frac_cell_used</span></span>
<span><span class="co">## 1 km2 = 80 per grid cell = (1*(10*10))*0.8 # assuming 80% grid cell used</span></span>
<span><span class="co">## Here I have assumed only 80% of cell is suitable. Upper/lower = 1/km - 6.25/km</span></span>
<span><span class="va">lhs_gen</span><span class="op">$</span><span class="fu">set_uniform_parameter</span><span class="op">(</span><span class="st">"max_dens"</span>, lower <span class="op">=</span> <span class="fl">80</span>, upper <span class="op">=</span> <span class="fl">500</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Translocation</span></span>
<span><span class="va">lhs_gen</span><span class="op">$</span><span class="fu">set_uniform_parameter</span><span class="op">(</span><span class="st">"trans_n"</span>, lower <span class="op">=</span> <span class="fl">10</span>, upper <span class="op">=</span> <span class="fl">100</span>, decimals <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sample_data</span> <span class="op">&lt;-</span> <span class="va">lhs_gen</span><span class="op">$</span><span class="fu">generate_samples</span><span class="op">(</span>number <span class="op">=</span> <span class="fl">10</span>, random_seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sample_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   q_thresh rmax_quantile standard_deviation dispersal_p dispersal_b</span></span>
<span><span class="co">#&gt; 1     0.97          0.72               0.31        0.21          15</span></span>
<span><span class="co">#&gt; 2     0.92          0.33               0.12        0.26           6</span></span>
<span><span class="co">#&gt; 3     0.95          0.05               0.47        0.32          21</span></span>
<span><span class="co">#&gt; 4     0.94          0.50               0.61        0.15          10</span></span>
<span><span class="co">#&gt; 5     0.98          0.85               0.39        0.38          37</span></span>
<span><span class="co">#&gt; 6     0.98          0.94               0.67        0.18          32</span></span>
<span><span class="co">#&gt;   dispersal_n_k_threshold max_dens trans_n</span></span>
<span><span class="co">#&gt; 1                    0.84      300      92</span></span>
<span><span class="co">#&gt; 2                    0.94      497      71</span></span>
<span><span class="co">#&gt; 3                    0.95      341      14</span></span>
<span><span class="co">#&gt; 4                    0.70      232      27</span></span>
<span><span class="co">#&gt; 5                    0.74      106      53</span></span>
<span><span class="co">#&gt; 6                    0.77      455      37</span></span>
<span></span>
<span><span class="co"># Make unique row names for saving files</span></span>
<span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54612</span><span class="op">)</span></span>
<span>  <span class="va">sample_data</span><span class="op">$</span><span class="va">UniqueID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/stringi/man/stri_rand_strings.html" class="external-link">stri_rand_strings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sample_data</span><span class="op">)</span>, <span class="fl">4</span>, <span class="st">"[A-Z]"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/stringi/man/stri_rand_strings.html" class="external-link">stri_rand_strings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sample_data</span><span class="op">)</span>, <span class="fl">4</span>, <span class="st">"[0-9]"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">sample_data</span> <span class="op">&lt;-</span> <span class="va">sample_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">sample_data</span></span>
<span><span class="co">#&gt;    UniqueID q_thresh rmax_quantile standard_deviation dispersal_p dispersal_b</span></span>
<span><span class="co">#&gt; 1  GFUR0745     0.97          0.72               0.31        0.21          15</span></span>
<span><span class="co">#&gt; 2  PEZO0880     0.92          0.33               0.12        0.26           6</span></span>
<span><span class="co">#&gt; 3  NWRT4531     0.95          0.05               0.47        0.32          21</span></span>
<span><span class="co">#&gt; 4  QFAA0197     0.94          0.50               0.61        0.15          10</span></span>
<span><span class="co">#&gt; 5  TDPB8128     0.98          0.85               0.39        0.38          37</span></span>
<span><span class="co">#&gt; 6  ZWCU8467     0.98          0.94               0.67        0.18          32</span></span>
<span><span class="co">#&gt; 7  HQPY9567     0.96          0.17               0.06        0.07          28</span></span>
<span><span class="co">#&gt; 8  LROH7589     0.93          0.21               0.54        0.11          23</span></span>
<span><span class="co">#&gt; 9  CETL2983     0.91          0.58               0.22        0.26          34</span></span>
<span><span class="co">#&gt; 10 ZOXX4201     0.92          0.64               0.19        0.36          16</span></span>
<span><span class="co">#&gt;    dispersal_n_k_threshold max_dens trans_n</span></span>
<span><span class="co">#&gt; 1                     0.84      300      92</span></span>
<span><span class="co">#&gt; 2                     0.94      497      71</span></span>
<span><span class="co">#&gt; 3                     0.95      341      14</span></span>
<span><span class="co">#&gt; 4                     0.70      232      27</span></span>
<span><span class="co">#&gt; 5                     0.74      106      53</span></span>
<span><span class="co">#&gt; 6                     0.77      455      37</span></span>
<span><span class="co">#&gt; 7                     1.00      200      78</span></span>
<span><span class="co">#&gt; 8                     0.88      393      44</span></span>
<span><span class="co">#&gt; 9                     0.85      278      85</span></span>
<span><span class="co">#&gt; 10                    0.79      128      61</span></span></code></pre></div>
<p>We we can run a simulation for each set (or row) of sampled
parameters. The <em>SimulationManager</em> class manages the generation
of parameters (via the generators), the running the model simulations,
and writing simulation results to disk. It also maintains a log of each
simulation’s success and any errors or warnings encountered.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">OUTPUT_DIR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">model_template</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">set_attributes</span><span class="op">(</span>params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"standard_deviation"</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="st">"dispersal_source_n_k$threshold"</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="st">"dispersal_source_n_k$cutoff"</span> <span class="op">=</span> <span class="fl">0.00</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build the simulation manager</span></span>
<span><span class="va">sim_manager</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SimulationManager.html">SimulationManager</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  sample_data <span class="op">=</span> <span class="va">sample_data</span>,</span>
<span>  model_template <span class="op">=</span> <span class="va">model</span>,</span>
<span>  <span class="co"># initial_hs = initial_hs,</span></span>
<span>  generators <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">dispersal_gen</span>, <span class="va">capacity_gen</span>, <span class="va">rmax_gen</span><span class="op">)</span>,</span>
<span>  parallel_cores <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  results_filename_attributes <span class="op">=</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="st">"UniqueID"</span>, <span class="st">"results"</span><span class="op">)</span>,</span>
<span>  results_ext <span class="op">=</span> <span class="st">".RDS"</span>,</span>
<span>  results_dir <span class="op">=</span> <span class="va">OUTPUT_DIR</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Takes &lt;10 seconds to run 10 example sims on a single core.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">run_output</span> <span class="op">&lt;-</span> <span class="va">sim_manager</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   2.817   0.255   3.108</span></span>
<span><span class="va">run_output</span><span class="op">$</span><span class="va">summary</span></span>
<span><span class="co">#&gt; [1] "10 of 10 sample models ran and saved results successfully with warnings"</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="step-6-extract-results-from-simulations">Step 6: Extract results from simulations<a class="anchor" aria-label="anchor" href="#step-6-extract-results-from-simulations"></a>
</h2>
<p>Now that the simulations have run, we can extract the modelled
abundances. We now wish to collate summary results for each of our
simulations via the <em>ResultsManager</em> class. This manager loads
the results from each sample simulation into an intermediate
<em>PopulationResults</em> class object, which dynamically generates
further results. We need to define functions for calculating summary
metrics, as well as any matrices (one row of values per simulation) that
we may be interested in examining.</p>
<p>We can see from above that the <code>run_output$summary</code> shows
that there were a number of simulations that didn’t complete
successfully:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_output</span><span class="op">$</span><span class="va">summary</span></span>
<span><span class="co">#&gt; [1] "10 of 10 sample models ran and saved results successfully with warnings"</span></span></code></pre></div>
<p>The <code>run_output$full_log</code> shows that some simulations
produced NA values when calculating population abundances:</p>
<p><code>"Warning: Non-finite stage abundances returned by user-defined translocation function"</code></p>
<p>These simulations had a range of parameter values that caused the
simulation to “fall-over”. These errors could be fixed by improving the
<code>translocation</code> function, or alternatively the user could
discard the simulations as being structurally wrong - i.e. that specific
combination of parameters is simply unsuitable. We’re going to treat
them as the latter.</p>
<div class="section level3">
<h3 id="extract-results">Extract results<a class="anchor" aria-label="anchor" href="#extract-results"></a>
</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract timeseries of abundance from each of the sims</span></span>
<span><span class="co"># Load our results (list) into a PopulationResults object</span></span>
<span><span class="va">p_results</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PopulationResults.html">PopulationResults</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>results <span class="op">=</span> <span class="va">run_output</span><span class="op">)</span></span>
<span><span class="va">res_manager</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ResultsManager.html">ResultsManager</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  simulation_manager <span class="op">=</span> <span class="va">sim_manager</span>,</span>
<span>  simulation_results <span class="op">=</span> <span class="va">p_results</span>,</span>
<span>  generators <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  summary_matrices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"n"</span>,</span>
<span>    <span class="st">"distr_pop"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  summary_functions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># total pop abundance</span></span>
<span>    <span class="st">"n"</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_results</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">sim_results</span><span class="op">$</span><span class="va">all</span><span class="op">$</span><span class="va">abundance</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="co"># matrix of abundance</span></span>
<span>    <span class="co">## can be made into raster</span></span>
<span>    <span class="st">"distr_pop"</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_results</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">sim_results</span><span class="op">$</span><span class="va">abundance</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span>,</span>
<span>  parallel_cores <span class="op">=</span> <span class="fl">1L</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gen_log</span> <span class="op">&lt;-</span> <span class="va">res_manager</span><span class="op">$</span><span class="fu">generate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gen_log</span><span class="op">$</span><span class="va">summary</span></span>
<span><span class="co">#&gt; [1] "10 of 10 summary metrics/matrices generated from sample results successfully"</span></span>
<span></span>
<span><span class="co"># matrix of total population abundances</span></span>
<span><span class="co">## each row is a sim, each column a timestep</span></span>
<span><span class="va">res_manager</span><span class="op">$</span><span class="va">summary_matrix_list</span><span class="op">$</span><span class="va">n</span></span>
<span><span class="co">#&gt;       [,1] [,2]  [,3]  [,4]  [,5]  [,6]   [,7]  [,8]  [,9] [,10] [,11]</span></span>
<span><span class="co">#&gt;  [1,]   92 3323  7026 15041 26668 22664  41992 41696 62850 41843 59052</span></span>
<span><span class="co">#&gt;  [2,]   71 1967  2021  3882  7892 10605  20999 25497 38943 43938 47138</span></span>
<span><span class="co">#&gt;  [3,]   14  264   420  2109  6779 13228  13882 25794 24008 32783 26782</span></span>
<span><span class="co">#&gt;  [4,]   27 1364  1799  3694  7062 12462  17371 29558 24840 34150 27849</span></span>
<span><span class="co">#&gt;  [5,]   53  961  6666  8417  9409 19195  14169 30511 17347 28239    NA</span></span>
<span><span class="co">#&gt;  [6,]   37 7833 45987 31579 88186 55046 128827 97272    NA    NA    NA</span></span>
<span><span class="co">#&gt;  [7,]   78  687   388   707  1804  3405   6199 10775 12983 14604 13386</span></span>
<span><span class="co">#&gt;  [8,]   44 1024   989  3589  7830 14645  17947 29238 28654 36924 32740</span></span>
<span><span class="co">#&gt;  [9,]   85 2270  8646 15371 20338 29326  33191 52467    NA    NA    NA</span></span>
<span><span class="co">#&gt; [10,]   61  875  2541  6666  8545 12917  14238 23607 20734 22180 21780</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">res_manager</span><span class="op">$</span><span class="va">summary_matrix_list</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">res_manager</span><span class="op">$</span><span class="va">summary_matrix_list</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>  lty <span class="op">=</span> <span class="fl">1</span>, xlab <span class="op">=</span> <span class="st">"timestep"</span>, ylab <span class="op">=</span> <span class="st">"total abundance"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-24-1.png" alt="plot of chunk unnamed-chunk-24"><p class="caption">
plot of chunk unnamed-chunk-24
</p>
</div>
<p>From the results we can see that our <code>translocation</code>
function was working correctly, and that our <code>capacity_gen</code>
was defined correctly, as the abundances in the first time step are the
same as the <code>trans_n</code> values from our latin-hypercube
samples.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">res_manager</span><span class="op">$</span><span class="va">summary_matrix_list</span><span class="op">$</span><span class="va">n</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">sample_data</span><span class="op">$</span><span class="va">trans_n</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Let’s assume that samples 2, 3, 4, and 8 are our “best” simulations
after some sort of validation. We have already extracted the abundances
from these simulations, so now with a few more lines of code, we can
generate averages of the simulations as rasters</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">best_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">res_manager</span><span class="op">$</span><span class="va">summary_matrix_list</span><span class="op">$</span><span class="va">distr_pop</span><span class="op">[</span><span class="va">best_sims</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]    4 8085</span></span>
<span></span>
<span><span class="va">best_abund</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>  nrow <span class="op">=</span> <span class="va">region</span><span class="op">$</span><span class="va">region_cells</span>,</span>
<span>  ncol <span class="op">=</span> <span class="fl">11</span>, <span class="co"># 11 timesteps,</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">res_manager</span><span class="op">$</span><span class="va">summary_matrix_list</span><span class="op">$</span><span class="va">distr_pop</span><span class="op">[</span><span class="va">best_sims</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">best_abund</span> <span class="op">&lt;-</span> <span class="va">region</span><span class="op">$</span><span class="fu">raster_from_values</span><span class="op">(</span><span class="va">best_abund</span><span class="op">)</span></span>
<span><span class="va">best_abund</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span>, <span class="fl">11</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; class      : RasterBrick </span></span>
<span><span class="co">#&gt; dimensions : 36, 34, 1224, 3  (nrow, ncol, ncell, nlayers)</span></span>
<span><span class="co">#&gt; resolution : 10000, 10000  (x, y)</span></span>
<span><span class="co">#&gt; extent     : -211571.8, 128428.2, -182583.2, 177416.8  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; crs        : +proj=laea +lat_0=-42.2 +lon_0=147 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source     : memory</span></span>
<span><span class="co">#&gt; names      : layer.1, layer.6, layer.11 </span></span>
<span><span class="co">#&gt; min values :       0,       0,        0 </span></span>
<span><span class="co">#&gt; max values :      39,     407,      634</span></span>
<span></span>
<span><span class="va">abd_max</span> <span class="op">&lt;-</span> <span class="fu">round_any</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">best_abund</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  accuracy <span class="op">=</span> <span class="fl">100</span>, <span class="va">ceiling</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot of log(x+1) abundances</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">best_abund</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">100</span>, <span class="st">"Spectral"</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  colNA <span class="op">=</span> <span class="st">"grey75"</span>,</span>
<span>  addfun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ibra_polygons</span>, border <span class="op">=</span> <span class="st">"#000000"</span>, col <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">abd_max</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: centre">
<img src="unnamed-chunk-26-1.png" alt="plot of chunk unnamed-chunk-26"><p class="caption">
plot of chunk unnamed-chunk-26
</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sean Haythorne, Damien Fordham, Stuart Brown, Jessie Buettel, Barry Brook, <a href="https://pilowsky.me" class="external-link">July Pilowsky</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
